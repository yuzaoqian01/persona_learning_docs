##  一、EIP-155 是什么？

**EIP-155**（Ethereum Improvement Proposal 155）是以太坊在 **2016 年** 提出的一个改进提案，
 核心目的是：

> **防止跨链重放攻击（Replay Attack）**。

它通过把 **`chainId`** 纳入交易签名计算，使交易签名在不同网络上互不兼容。

## 二、为什么需要 EIP-155？

### 问题：重放攻击（Replay Attack）

在早期以太坊（Homestead 之前），交易签名的内容中 **没有区分不同链**。
 这导致了严重的安全问题：

> 一笔在 Ropsten 测试网上的签名交易，**可以被直接在主网重放执行**。

举个例子：

- 你在 **测试网 (chainId = 3)** 上签署一笔 “发送 1 ETH” 的交易；
- 攻击者复制交易数据；
- 然后把它发到 **主网 (chainId = 1)**；
- 结果主网上也转出了你的 1 ETH。

这就是「重放攻击」。

## 三、EIP-155 的解决方案

EIP-155 在签名时引入一个新的字段：`chainId`。

在签名计算时，`v` 的值不再只是 `27` 或 `28`，
 而是：

```
v = chainId * 2 + 35 或 36
```

这样，不同链的 `v` 不同，因此签名结果也不同。

# 四、EIP-155 如何改变签名结构？

在以太坊的签名中，最核心的是三个值：

| 字段 | 含义                              |
| ---- | --------------------------------- |
| `v`  | 恢复 ID（recovery id）            |
| `r`  | 签名的一部分（椭圆曲线点 x 坐标） |
| `s`  | 签名的一部分（曲线签名结果）      |

EIP-155 修改了 **`v` 的含义**。

------

##  EIP-155 的新签名计算方式

签名时加入链 ID：

```
v = chainId * 2 + 35 或 36
```

举例：

| 网络             | chainId | v 值      |      |
| ---------------- | ------- | --------- | ---- |
| Ethereum Mainnet | 1       | 37 / 38   | ✅    |
| Goerli           | 5       | 45 / 46   | ✅    |
| BSC              | 56      | 147 / 148 | ✅    |
| Polygon          | 137     | 309 / 310 | ✅    |

这使得签名和链绑定在一起，无法在其他链上重放。

在没有 EIP-155 之前，交易 RLP 编码如下：

```
[nonce, gasPrice, gasLimit, to, value, data, v, r, s]
```

应用 EIP-155 之后，签名前的 RLP 数据为：

```
[nonce, gasPrice, gasLimit, to, value, data, chainId, 0, 0]
```

签名后：

- `v = chainId * 2 + 35 或 36`
- `r`、`s` 是签名的结果

这意味着：

> 签名时把 `chainId` 纳入了 hash → 签名结果唯一绑定链 ID。

原始交易签名包含：

```
{
  "nonce": 1,
  "gasPrice": "20000000000",
  "gas": 21000,
  "to": "0x1234...",
  "value": "1000000000000000000",
  "data": "0x",
  "chainId": 1
}
```

签名结果（简化）：

```
{
  "v": 37,
  "r": "0x...",
  "s": "0x..."
}
```

> ⚠️ 关键：`v = 37` 表示这是在 `chainId=1` 上签的交易。

## 五、CAIP-2 命名规范中的 `eip155:<chainId>`

在 WalletConnect、AppKit、RainbowKit、LI.FI 等 Web3 SDK 中，
 你经常看到这样的字符串：

```
eip155:1
eip155:56
eip155:137
```

这是 [CAIP-2](https://github.com/ChainAgnostic/CAIPs/blob/master/CAIPs/caip-2.md) 规范定义的链命名方式：

```
<namespace>:<reference>
```

- **namespace** → 技术体系，如 `eip155`（EVM 系链）、`solana`、`bip122`（比特币）、`tron` 等
- **reference** → 具体链 ID 或网络标识

### 示例表：

| 网络              | 命名空间标识   | 含义                     |
| ----------------- | -------------- | ------------------------ |
| Ethereum Mainnet  | `eip155:1`     | 主网                     |
| Polygon           | `eip155:137`   | Polygon 主网             |
| BSC               | `eip155:56`    | Binance Smart Chain 主网 |
| Arbitrum          | `eip155:42161` | Arbitrum One             |
| Optimism          | `eip155:10`    | Optimism Mainnet         |
| Avalanche C-Chain | `eip155:43114` | Avalanche EVM 链         |
| Base              | `eip155:8453`  | Coinbase Base 链         |

# 六、EIP-155 在签名算法中的实现细节

签名算法（以 ECDSA 为例）：

```
sig = ECDSA_sign(keccak256(RLP([nonce, gasPrice, gas, to, value, data, chainId, 0, 0])))
```

注意这里多了 `chainId, 0, 0` 三个字段。
 它们共同确保了签名绑定到特定链。

## 七、在现代 Web3 框架中的体现

### 1  wagmi / viem

`wagmi` 和 `viem` 使用 `chain.id`（EIP-155 chainId）来区分网络：

```js
import { mainnet, polygon, bsc } from 'wagmi/chains'

console.log(mainnet.id) // 1
console.log(polygon.id) // 137
console.log(bsc.id)     // 56
```

这些 ID 就是 EIP-155 定义的链 ID。

------

### wagmi / viem

```js
import { createConfig, http } from 'wagmi'
import { mainnet, polygon } from 'wagmi/chains'

export const config = createConfig({
  chains: [mainnet, polygon],
  transports: {
    [mainnet.id]: http(),
    [polygon.id]: http(),
  },
})
```

这里 `mainnet.id = 1`，
 `polygon.id = 137`，
 内部使用的就是 `eip155:1` 和 `eip155:137`。

### 2  WalletConnect v2

WalletConnect 使用 **CAIP-2 + EIP-155** 的链命名方式：

```js
{
  namespaces: {
    eip155: {
      chains: ['eip155:1', 'eip155:137'],
      methods: ['eth_sendTransaction', 'personal_sign'],
      events: ['chainChanged', 'accountsChanged'],
    }
  }
}
```

这样钱包就知道你希望在哪些链上发交易。

------

```ts
const wagmiAdapter = new WagmiAdapter({
  projectId: 'your_project_id',
  networks: [mainnet, polygon],
  namespaces: {
    eip155: {
      chains: ['eip155:1', 'eip155:137'],
      methods: ['eth_sendTransaction', 'personal_sign'],
      events: ['chainChanged', 'accountsChanged'],
    },
  },
})
```

AppKit 用这个命名空间来：

管理多链连接；

控制钱包可交互的范围；

验证交易签名时对应的链。

### 3  Reown AppKit

Reown AppKit 内部也基于 EIP-155/CAIP-2：

```js
const wagmiAdapter = new WagmiAdapter({
  projectId,
  networks: [mainnet, polygon],
})
```

AppKit 会在内部转换成：

```js
namespaces: {
  eip155: {
    chains: ['eip155:1', 'eip155:137'],
  }
}
```

# 八、EIP-155 之后的扩展：EIP-2718、EIP-2930、EIP-1559

EIP-155 是以太坊签名安全的起点，
 之后衍生了多个改进：

| EIP          | 目的                                      | 关系             |
| ------------ | ----------------------------------------- | ---------------- |
| **EIP-155**  | 防重放攻击                                | 基础             |
| **EIP-2718** | 通用交易封装类型（Typed Transaction）     | 统一不同交易类型 |
| **EIP-2930** | 支持 Access List                          | 扩展交易类型     |
| **EIP-1559** | 动态手续费机制（Base Fee + Priority Fee） | 改变 gas 模型    |

这些标准共同构成了现代以太坊交易结构。

# 九、常见问题（FAQ）

### 1. 所有链都用了 EIP-155 吗？

是的，所有 EVM 兼容链（BSC、Polygon、Arbitrum、Base、OP、Avalanche 等）
 都使用了 EIP-155。

------

### 2. 为什么叫 “eip155:chainId”？

这是基于 CAIP-2 标准。
 `eip155` 是 namespace，代表 EVM 系列链。
 `chainId` 是链的 ID。

------

### 3. 旧钱包或旧交易还支持不带 chainId 的签名吗？

部分非常旧的钱包可能兼容，但现代节点会拒绝这种交易。
 实际开发中 **必须使用 EIP-155 签名格式**。

------

### 4. PSBT、BTC、Solana 有类似机制吗？

有的，只是实现方式不同：

- **BTC**：通过不同的签名前缀（sighash type）防止重放；
- **Solana**：交易中嵌入特定 blockhash；
- **EVM**：通过 EIP-155 中的 chainId 实现。

------

# 十、总结表

| 项目                                     | 含义                                        |
| ---------------------------------------- | ------------------------------------------- |
| **EIP-155**                              | 把 `chainId` 纳入交易签名，防止跨链重放攻击 |
| **v = chainId \* 2 + 35/36**             | 新的签名恢复标识                            |
| **eip155:chainId**                       | CAIP-2 标准命名，用于多链环境               |
| **wagmi / viem / Reown / WalletConnect** | 都基于 EIP-155 来区分链与签名               |
| **结果**                                 | 每条链的签名互不通用，安全性显著提升        |