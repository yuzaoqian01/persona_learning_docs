# **EIP-6963：多钱包发现标准（Multi Injected Provider Discovery）**

EIP-6963 是一个专门为 **Web3 DApp 多钱包兼容性**设计的标准，它解决了用户同时安装多个钱包时，DApp 无法同时识别多个钱包的问题。

------

## **1 背景与问题**

在传统 DApp 开发中，钱包通常通过 **`window.ethereum`** 注入以太坊 Provider，例如：

```
window.ethereum
```

问题：

1. **竞争条件（Wallet Contention）**
   - 如果用户安装多个浏览器钱包（MetaMask、Coinbase Wallet、Trust Wallet），每个钱包都尝试注入 `window.ethereum`。
   - 最后注入的那个钱包覆盖之前的，导致 DApp 只能识别一个钱包。
2. **用户体验差**
   - 用户无法在 DApp 中自由选择钱包。
   - DApp 无法显示“已安装钱包列表”，限制了选择。
3. **新钱包难以进入市场**
   - 新钱包很难与已存在的钱包竞争 `window.ethereum` 注入位置。

💡 **EIP-6963 的目标**：允许 DApp **发现并列出所有已安装钱包**，提供用户自由选择，并兼容现有 Provider 接口。

------

## **2  核心设计**

EIP-6963 通过 **事件驱动机制**实现多钱包发现：

### **2.1 事件机制**

1. **DApp 请求钱包**

```js
window.dispatchEvent(new CustomEvent('eip6963:requestProvider'));
```

- DApp 广播 `eip6963:requestProvider` 事件，请求已安装的钱包回应。

1. **钱包宣布自己**

钱包收到请求事件后，会触发 `eip6963:announceProvider` 事件，向 DApp 宣布自己：

```js
window.dispatchEvent(new CustomEvent('eip6963:announceProvider', {
  detail: {
    uuid: 'unique-wallet-id',
    name: 'MetaMask',
    icon: 'https://metamask.io/icon.png',
    rdns: 'io.metamask',
    provider: window.ethereum
  }
}));
```

- **`uuid`**：全局唯一标识符
- **`name`**：钱包名称
- **`icon`**：钱包图标 URL
- **`rdns`**：反向域名系统标识符（钱包开发者信息）
- **`provider`**：实际 Provider 对象

> 通过这些信息，DApp 可以显示钱包列表供用户选择，并区分不同钱包。

------

### **2.2 Provider 信息结构**

EIP-6963 规范了钱包向 DApp 提供的信息结构：

| 字段       | 类型   | 描述                                |
| ---------- | ------ | ----------------------------------- |
| `uuid`     | string | 钱包实例唯一标识                    |
| `name`     | string | 钱包名称                            |
| `icon`     | string | 钱包图标 URL                        |
| `rdns`     | string | 开发者标识（反向域名）              |
| `provider` | object | 钱包 Provider 对象（兼容 EIP-1193） |

------

## **3 使用流程（DApp 侧）**

1. **触发钱包发现事件**

```js
window.dispatchEvent(new CustomEvent('eip6963:requestProvider'));
```

1. **监听钱包响应事件**

```js
window.addEventListener('eip6963:announceProvider', (event) => {
  const wallet = event.detail;
  console.log('发现钱包:', wallet.name, wallet.provider);
});
```

1. **构建钱包选择 UI**

- 根据 `name`、`icon` 显示钱包列表
- 用户选择钱包后，使用其 `provider`（EIP-1193 兼容）进行交易或签名

------

## **4 钱包侧实现**

钱包扩展收到 `eip6963:requestProvider` 事件后，需要：

```js
window.addEventListener('eip6963:requestProvider', () => {
  window.dispatchEvent(new CustomEvent('eip6963:announceProvider', {
    detail: {
      uuid: 'unique-id',
      name: 'Wallet Name',
      icon: 'wallet-icon-url',
      rdns: 'wallet.developer',
      provider: window.ethereum
    }
  }));
});
```

- 保持 **Provider 与 EIP-1193 兼容**
- 支持 **多钱包同时注入**
- 支持 **事件重复触发**，确保 DApp 能动态发现钱包

------

## **5 优势与应用**

### **优势**

1. **多钱包发现**
   - DApp 可以同时发现用户浏览器中安装的多个钱包
2. **用户选择自由**
   - DApp 可展示钱包列表，让用户选择偏好钱包
3. **兼容性强**
   - 向后兼容传统 `window.ethereum` 模式
4. **开发者友好**
   - 提供统一接口和信息结构，减少兼容性问题

### **应用场景**

- **Web3 游戏或 DApp**：用户可选择 MetaMask 或 Trust Wallet 登录
- **跨链 DApp**：用户可选择特定钱包进行跨链交易
- **钱包聚合平台**：显示用户浏览器中所有可用钱包

------

## **6 与 EIP-1193 的关系**

- **EIP-1193**：定义 Provider 与 DApp 交互标准（方法、事件、签名、交易）
- **EIP-6963**：扩展 EIP-1193，解决 **多钱包发现与选择问题**

💡 可以理解为：

> **EIP-1193 是基础通信协议，EIP-6963 是钱包发现层协议。**

------

## **7 总结**

EIP-6963 是 Web3 DApp 生态中解决 **多钱包识别、用户体验与兼容性**问题的重要标准：

- **事件驱动**：`eip6963:requestProvider` → `eip6963:announceProvider`
- **多钱包支持**：不再被 `window.ethereum` 覆盖
- **统一数据结构**：方便构建钱包选择 UI
- **兼容 EIP-1193**：Provider 与交易签名、事件机制兼容

> 对于现代 DApp 开发者来说，支持 EIP-6963 能显著提升用户体验和钱包兼容性，尤其是在用户可能安装多个钱包的情况下。