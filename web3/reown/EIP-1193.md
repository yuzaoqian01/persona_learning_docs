# **EIP-1193：以太坊 Provider 标准详解**

EIP-1193 定义了 **以太坊 DApp 与钱包交互的统一接口**，核心是 `Ethereum Provider` 对象。它解决了不同钱包实现差异大、事件和方法不统一的问题。

------

## **1 核心概念**

### 1. Ethereum Provider

- 是 DApp 与钱包通信的桥梁
- 在浏览器环境中通常通过 `window.ethereum` 暴露
- 必须实现一个统一的 API（主要是 `request` 方法）和事件系统

### 2. 统一调用方法：`request`

```js
ethereum.request({ method: string, params?: any[] | object }): Promise<any>
```

特点：

- **方法名标准化**：所有操作通过 `method` 指定
- **参数统一化**：通过 `params` 提供，可是数组或对象
- **返回 Promise**：方便处理异步调用
- **错误处理**：所有异常都以标准化对象返回，包含 `code` 和 `message`

示例：

```js
// 获取账户
const accounts = await ethereum.request({ method: 'eth_accounts' });

// 请求用户授权
const authorizedAccounts = await ethereum.request({ method: 'eth_requestAccounts' });

// 发送交易
const txHash = await ethereum.request({
  method: 'eth_sendTransaction',
  params: [{
    from: '0xYourAddress',
    to: '0xRecipient',
    value: '0x29a2241af62c0000', // 0.1 ETH
    gas: '0x5208',               // 21000
  }],
});
```

------

## **2 事件系统**

Provider 支持事件订阅机制，便于 DApp 动态响应账户或链的变化。

### 1. 常用事件

| 事件名            | 描述                       |
| ----------------- | -------------------------- |
| `accountsChanged` | 用户切换账户               |
| `chainChanged`    | 用户切换网络/链            |
| `disconnect`      | 钱包断开连接               |
| `connect`         | 钱包连接                   |
| `message`         | 一般信息事件，例如签名请求 |

### 2. 订阅方法

```js
ethereum.on('accountsChanged', (accounts: string[]) => {
  console.log('New accounts:', accounts);
});

ethereum.on('chainChanged', (chainId: string) => {
  console.log('Switched chain:', chainId);
});

// 取消订阅
ethereum.removeListener('accountsChanged', handlerFunction);
```

> 注意：
>
> - `accountsChanged` 会返回 **一个账户数组**，可能为空（用户断开连接）
> - `chainChanged` 返回的是 **十六进制字符串**形式的 chainId，如 `0x1`（主网）

------

## **3 Provider 支持的方法**

### 账户与权限

| 方法                  | 说明                       |
| --------------------- | -------------------------- |
| `eth_accounts`        | 获取当前已连接账户，不弹窗 |
| `eth_requestAccounts` | 请求用户授权，弹出钱包窗口 |

### 链与网络

| 方法                         | 说明                    |
| ---------------------------- | ----------------------- |
| `net_version`                | 获取链 ID（字符串形式） |
| `eth_chainId`                | 获取当前链 ID（hex）    |
| `wallet_switchEthereumChain` | 切换网络（EIP-3326）    |
| `wallet_addEthereumChain`    | 添加新网络（EIP-3085）  |

### 交易与签名

| 方法                  | 说明                        |
| --------------------- | --------------------------- |
| `eth_sendTransaction` | 发送交易（需要用户签名）    |
| `eth_signTransaction` | 签名交易，但不发送          |
| `personal_sign`       | 对消息进行签名              |
| `eth_signTypedData`   | 对结构化数据签名（EIP-712） |

### 查询链上数据

| 方法                        | 说明             |
| --------------------------- | ---------------- |
| `eth_call`                  | 调用合约只读方法 |
| `eth_getBalance`            | 查询余额         |
| `eth_getTransactionReceipt` | 获取交易回执     |

------

## **4 错误处理**

EIP-1193 定义了统一错误对象：

```js
{
  code: number,
  message: string,
  data?: any
}
```

常见错误码：

| 错误码 | 含义                             |
| ------ | -------------------------------- |
| 4001   | 用户拒绝操作（如拒绝授权或交易） |
| -32601 | 方法不存在                       |
| -32602 | 参数错误                         |
| -32000 | 内部错误（例如余额不足）         |

示例：

```js
try {
  const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
} catch (error) {
  if (error.code === 4001) {
    console.log('User rejected request');
  } else {
    console.error(error);
  }
}
```

------

## **5 Provider 与 DApp 交互流程**

1. **DApp 初始化**：检测 `window.ethereum`
2. **请求账户**：`eth_requestAccounts`
3. **用户授权**：
   - 同意 → 返回账户
   - 拒绝 → 返回 4001 错误
4. **调用链方法或发送交易**
5. **订阅事件**：
   - `accountsChanged` → 更新 UI
   - `chainChanged` → 刷新链数据
6. **处理返回结果或错误**

------

## **6 与扩展标准关系**

- **EIP-1193**：Provider 基础接口
- **EIP-3085**：添加网络
- **EIP-3326**：切换网络
- **EIP-712**：结构化数据签名

> 可以把 EIP-1193 看作 **基础协议**，其他 EIP 都是它的扩展方法。

------

## **7 总结**

EIP-1193 的核心是：

1. **统一接口**：`request({ method, params })`
2. **事件驱动**：`on` / `removeListener`
3. **标准错误**：`code` + `message`
4. **兼容性高**：不同钱包遵循这个标准就能无缝集成

它是现代 DApp 前端开发不可或缺的标准，也是钱包和跨链 DApp 开发的基石。